---
title: "GBE_Fachaerzte"
author: "Jakob Schumacher"
date: "11 Mai 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
library(stringi)
library(data.table)
library(ggthemes)
library(plotly)
```

## Getting the data

GBE-Bund.de
http://www.gbe-bund.de/oowa921-install/servlet/oowa/aw92/WS0100/_XWD_FORMPROC?TARGET=&PAGE=_XWD_320&OPINDEX=1&HANDLER=XS_ROTATE_ADVANCED&DATACUBE=_XWD_348&D.000=ACROSS&D.001=DOWN&D.002=DOWN&D.003=DOWN&D.395=DOWN&D.928=DOWN&D.100=PAGE 

Bei den Ärztekammern registrierte Ärztinnen und Ärzte mit Gebiets- und Facharztbezeichnung (absolut, je 100.000 Einwohner und Einwohner je Arzt). Gliederungsmerkmale: Jahre, Region, Alter, Geschlecht, Gebiets-/Facharztbezeichnung, Taetigkeitsbereich

Merkmale
<!-- Zeile: Region, Alter, Geschlecht, Facharzbezeichnung, Taetigkeitsbereich -->
Spalte: Jahr
Blatt: Darstellung

```{r ögd}

# To be set
fileToRead = "Taetigkeit_Fachbereich_Jahr.csv"
linesToSkip = 15
namesOfVariables = c("Bereich", "Fachgebiet")

# Get variables names ready for col.names argument
preRead <- read.csv(fileToRead, skip = linesToSkip, sep = ";", nrow = 1, header = F)
variablesToName <- c(namesOfVariables, as.character(preRead[min(which(!is.na(preRead))):ncol(preRead)]))

# Read in data
data <- read.csv(file = fileToRead, sep = ";",  fileEncoding = "ISO-8859-1", skip = linesToSkip, na.strings = c(""," ","NA", "\\"), strip.white = TRUE, col.names = variablesToName)

# Remove unecessary variables
rm(preRead, linesToSkip, fileToRead, variablesToName)
data$NA. <- NULL

# Remove the footnotes
data <- data[1:which(grepl("\\*", data[,1]))[1] - 1,]

# Transform dataset to long format
data <- data %>% 
  rename_at(vars(starts_with("X")), funs(str_replace(., "X", ""))) %>% 
  mutate_all(function(x) (str_trim(x))) %>% 
  fill_(namesOfVariables, .direction = "down") %>% 
  mutate_all(function(x) (gsub(pattern = "\\.", replacement =  "", x))) %>% 
  gather(key = "key", value = "value", -namesOfVariables) %>% 
  rename(Jahr = key) 

data <- data %>% 
  filter(Bereich != "Tätigkeitsbereiche insgesamt") %>%
  filter(Bereich != "Ohne ärztliche Tätigkeit") %>% 
  filter(Bereich != "Mit ärztlicher Tätigkeit") %>% 
  filter(Bereich != "Niedergelassen") %>% 
  filter(Bereich != "Angestellt") %>% 
  filter(Fachgebiet != "Gebiets-/Facharztbezeichnungen insgesamt (incl ohne Gebiet)") %>%
  mutate(Bereich = fct_recode(Bereich, 
                                         "Behörden" = "In Behörden/Körperschaften u a", 
                                         "Sonstige" = "In sonstigen Bereichen",
                                         "Ambulant" = "Ambulant",
                                         "Stationär" = "Stationär")) %>% 
  mutate(Bereich = fct_relevel(Bereich, 
                                         "Sonstige",
                                         "Ambulant",
                                         "Stationär",
                                         "Behörden"
                                         )) %>% 
  distinct() %>% 
  mutate_at(vars(-value), factor) %>% 
  mutate(value = as.integer(value))
  
```

## Anzahl der Fachärzte für öffentliches Gesundheitswesen zwischen 1991 und 2017
```{r pressure, results='asis'}
g <- data %>% 
  filter(Fachgebiet == "Öffentliches Gesundheitswesen") %>%
  ggplot(aes(x = Jahr, y = value, fill = Bereich)) +
  geom_bar(stat = "identity") +
  # facet_wrap(. ~ Fachgebiet) +
  ggtitle("Fachärzte für öffentliches Gesundheitswesen") +
  xlab("Jahr") +
  ylab("Anzahl an Fachärzten") +
  theme_classic(base_family = "sans",
                base_size = 11) +
  theme(axis.text.x  = element_text(angle = 90, vjust = 0),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  scale_fill_brewer() 
  
ggplotly(g)
```

## Anzahl der Fachärzte für öffentliches Gesundheitswesen zwischen 1991 und 2017
```{r several, results='asis'}
g <- data %>% 
  filter(Fachgebiet %in% c("Öffentliches Gesundheitswesen", 
                           "Innere Medizin", 
                           "Chirurgie",
                           "Hygiene und Umweltmedizin",
                           "Allgemeinmedizin",
                           "Ohne Gebiet",
                           "Ohne Facharztbezeichnung",
                           "Mikrobiologie, Virologie, Infektionsepidemiologie",
                           "Sozialhygiene")) %>%
  ggplot(aes(x = Jahr, y = value, fill = Bereich)) +
  geom_bar(stat = "identity") +
  facet_wrap(. ~ Fachgebiet, scales = "free") +
  xlab("Jahr") +
  ylab("Anzahl an Fachärzten") +
  theme_classic(base_family = "sans",
                base_size = 11) +
  theme(axis.text.x  = element_text(angle = 90, vjust = 0),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  scale_fill_brewer() 
  
ggplotly(g)
```



```{r}
data %>% 
  filter(as.integer(Fachgebiet) == 40) %>%
  group_by(Bereich) %>% 
  summarise(sum(value)) 
```

